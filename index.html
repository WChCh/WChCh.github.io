<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Cloud Computing, BigData, ML" />










<meta name="description" content="不管年龄大小，每个人都是我的老师">
<meta property="og:type" content="website">
<meta property="og:title" content="Alex‘s Blog">
<meta property="og:url" content="https://wchch.github.io/index.html">
<meta property="og:site_name" content="Alex‘s Blog">
<meta property="og:description" content="不管年龄大小，每个人都是我的老师">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Alex‘s Blog">
<meta name="twitter:description" content="不管年龄大小，每个人都是我的老师">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://wchch.github.io/"/>





  <title>Alex‘s Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Alex‘s Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Coding My Life</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wchch.github.io/2020/03/25/euler简单上手/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alex Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/user_defined/logo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Alex‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/25/euler简单上手/" itemprop="url">euler简单上手</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-25T10:13:22+08:00">
                2020-03-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TensorFlow/" itemprop="url" rel="index">
                    <span itemprop="name">TensorFlow</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TensorFlow/深度学习/" itemprop="url" rel="index">
                    <span itemprop="name">深度学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>本文主要介绍euler利用docker再单机上模拟分布式训练，分布式模型评估，分布式embedding的简单上手体验过程，一些基础的工作我已经准备好了。如果只是单机的训练等，直接参考官方文档就好了，可以在本地的环境或是利用现有的docker环境都可以。</p>
<p>本教程主要用<code>docker-compose在</code>单台物理机上来模拟多主机环境，后面如需要跑在k8s环境中可参考其中内容进行改造即可。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="源码下载"><a href="#源码下载" class="headerlink" title="源码下载"></a>源码下载</h3><ol>
<li><p>git clone –recursive <a href="https://github.com/alibaba/euler.git`" target="_blank" rel="noopener">https://github.com/alibaba/euler.git`</a></p>
</li>
<li><p>如果过程中<code>clone</code>失败，那么进入主目录使用<code>submodule update --init --recursive --progress</code>检出各个子模块</p>
</li>
<li><p>对于目录<code>D:\shadowsocks\euler\third_party</code>要检出第三方依赖的问题，</p>
<ol>
<li><p>如果报的是<code>zookeeper</code>的<code>Unable to find current revision in submodule path</code>问题，那么可以在当前目录中直接将zookeeper的代码<code>clone</code>下来，然后再切换到源码中指定的<code>commit</code>版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/apache/zookeeper.git`</span><br><span class="line">cd zookeeper</span><br><span class="line">git checkout 05b774a1b05374618300f657c9c91b0d5c6ddf71</span><br></pre></td></tr></table></figure>
</li>
<li><p>如何因为网络原因无法<code>clone</code>，则可以先再网上找到相应的包，然后再修改<code>commit</code>版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 使用此链接下载Fuzzer并解压：https://github-production-repository-file-5c1aeb.s3.amazonaws.com/165004157/2991980?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20200228%2Fus-east-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20200228T111759Z&amp;X-Amz-Expires=300&amp;X-Amz-Signature=0e9db781ee0e38e1b1c02cfbdeff669484631d9aa2c5bbfa64c9c243b6bab2f6&amp;X-Amz-SignedHeaders=host&amp;actor_id=8743639&amp;response-content-disposition=attachment%3Bfilename%3DFuzzer.zip&amp;response-content-type=application%2Fzip</span><br><span class="line">2. 将Fuzzer文件夹名称改成libFuzzer，并且进入此文件夹。</span><br><span class="line">3. 修改commit版本：git checkout 1b543d6e5073b56be214394890c9193979a3d7e1</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果别的依赖子模块出现问题可参考以上两种方法。</p>
</li>
</ol>
</li>
</ol>
<p><strong>在当前进度下，安装时建议使用master分支</strong></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/03/25/euler简单上手/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wchch.github.io/2019/11/27/使用Flink-SQL读取kafka数据并通过JDBC方式写入Clickhouse实时场景的简单实例/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alex Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/user_defined/logo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Alex‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/27/使用Flink-SQL读取kafka数据并通过JDBC方式写入Clickhouse实时场景的简单实例/" itemprop="url">使用Flink SQL读取kafka数据并通过JDBC方式写入Clickhouse实时场景的简单实例</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-27T16:43:55+08:00">
                2019-11-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/实时/" itemprop="url" rel="index">
                    <span itemprop="name">实时</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/实时/olap/" itemprop="url" rel="index">
                    <span itemprop="name">olap</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/实时/olap/BigData/" itemprop="url" rel="index">
                    <span itemprop="name">BigData</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/实时/olap/BigData/clickhouse/" itemprop="url" rel="index">
                    <span itemprop="name">clickhouse</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/实时/olap/BigData/clickhouse/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>读取kafka数据并且经过ETL后，通过JDBC存入clickhouse中</p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>定义POJO类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String date;</span><br><span class="line">    <span class="comment">//构造，setter 和 getter 省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完整代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">env.setParallelism(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">final</span> StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br><span class="line"></span><br><span class="line"><span class="comment">//###############定义消费kafka source##############</span></span><br><span class="line">Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">props.put(<span class="string">"bootstrap.servers"</span>, <span class="string">"localhost:9092"</span>);</span><br><span class="line">props.put(<span class="string">"zookeeper.connect"</span>, <span class="string">"localhost:2181"</span>);</span><br><span class="line">props.put(<span class="string">"group.id"</span>, <span class="string">"metric-group"</span>);</span><br><span class="line">props.put(<span class="string">"key.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">props.put(<span class="string">"value.deserializer"</span>,<span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">props.put(<span class="string">"auto.offset.reset"</span>, <span class="string">"latest"</span>);</span><br><span class="line"></span><br><span class="line">tableEnv.connect(<span class="keyword">new</span> Kafka().version(<span class="string">"0.10"</span>)</span><br><span class="line">        .topic(<span class="string">"student"</span>).properties(props).startFromLatest())</span><br><span class="line">        .withFormat(<span class="keyword">new</span> Json().deriveSchema())</span><br><span class="line">        .withSchema(<span class="keyword">new</span> Schema().field(<span class="string">"id"</span>, Types.INT())</span><br><span class="line">                                .field(<span class="string">"name"</span>, Types.STRING())</span><br><span class="line">                                .field(<span class="string">"password"</span>, Types.STRING())</span><br><span class="line">                                .field(<span class="string">"age"</span>, Types.INT())</span><br><span class="line">                                .field(<span class="string">"date"</span>, Types.STRING()))</span><br><span class="line">        .inAppendMode()</span><br><span class="line">        .registerTableSource(<span class="string">"kafkaTable"</span>);</span><br><span class="line">Table result = tableEnv.sqlQuery(<span class="string">"SELECT * FROM "</span> +  <span class="string">"kafkaTable"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//###############定义clickhouse JDBC sink##############</span></span><br><span class="line">String targetTable = <span class="string">"clickhouse"</span>;</span><br><span class="line">TypeInformation[] fieldTypes = &#123;BasicTypeInfo.INT_TYPE_INFO,BasicTypeInfo.STRING_TYPE_INFO,BasicTypeInfo.STRING_TYPE_INFO, BasicTypeInfo.INT_TYPE_INFO, BasicTypeInfo.STRING_TYPE_INFO&#125;;</span><br><span class="line">TableSink jdbcSink =  JDBCAppendTableSink.builder()</span><br><span class="line">                      .setDrivername(<span class="string">"ru.yandex.clickhouse.ClickHouseDriver"</span>)</span><br><span class="line">                      .setDBUrl(<span class="string">"jdbc:clickhouse://localhost:8123"</span>)</span><br><span class="line">                      .setQuery(<span class="string">"insert into student_local(id, name, password, age, date) values(?, ?, ?, ?, ?)"</span>)</span><br><span class="line">                      .setParameterTypes(fieldTypes)</span><br><span class="line">                      .setBatchSize(<span class="number">15</span>)</span><br><span class="line">                      .build();</span><br><span class="line"></span><br><span class="line">tableEnv.registerTableSink(targetTable,<span class="keyword">new</span> String[]&#123;<span class="string">"id"</span>,<span class="string">"name"</span>, <span class="string">"password"</span>, <span class="string">"age"</span>, <span class="string">"date"</span>&#125;, <span class="keyword">new</span> TypeInformation[]&#123;Types.INT(), Types.STRING(), Types.STRING(), Types.INT(), Types.STRING()&#125;, jdbcSink);</span><br><span class="line"></span><br><span class="line">result.insertInto(targetTable);</span><br><span class="line">env.execute(<span class="string">"Flink add sink"</span>);</span><br></pre></td></tr></table></figure>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2019/11/27/使用Flink-SQL读取kafka数据并通过JDBC方式写入Clickhouse实时场景的简单实例/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wchch.github.io/2019/10/27/制作可传参的docker-clickhouse-client/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alex Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/user_defined/logo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Alex‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/27/制作可传参的docker-clickhouse-client/" itemprop="url">制作可传参的docker clickhouse-client</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-27T20:26:51+08:00">
                2019-10-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/olap/" itemprop="url" rel="index">
                    <span itemprop="name">olap</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/olap/BigData/" itemprop="url" rel="index">
                    <span itemprop="name">BigData</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/olap/BigData/clickhouse/" itemprop="url" rel="index">
                    <span itemprop="name">clickhouse</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/olap/BigData/clickhouse/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Dockerfile：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM clickhouse-client:latest</span><br><span class="line"></span><br><span class="line">ENV HOST="localhost"</span><br><span class="line">ENV USER="default"</span><br><span class="line">ENV PASSWORD=""</span><br><span class="line">ENV DATABASE="default"</span><br><span class="line">ENTRYPOINT /usr/bin/clickhouse-client -h $HOST -u $USER --password $PASSWORD -d $DATABASE</span><br></pre></td></tr></table></figure>
<p>运行命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm --name clickhouse-client -e HOST="10.185.xx.xx" -e USER="user" -e PASSWORD="xxxx" -e DATABASE="db"  clickhouse-client:param</span><br></pre></td></tr></table></figure>
<p>遇到问题：</p>
<p>当ENTRYPOINT使用方括号并且里面的参数是明文而不是环境变量时，是可以运行的，如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ENTRYPOINT [&quot;/usr/bin/clickhouse-client&quot;,&quot;-h&quot;,&quot;10.185.xx.xx&quot;,&quot;-u&quot;,&quot;user&quot;,&quot;--password&quot;,&quot;xxx&quot;]</span><br></pre></td></tr></table></figure>
<p>但是形如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ENTRYPOINT ["/usr/bin/clickhouse-client","-h",$HOST,"-u",$USER,"--password",$PASSWORD]</span><br></pre></td></tr></table></figure>
<p>就会报：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/sh 1 [/usr/bin/clickhouse-client,-h,10.185.xx.xx,-u,user,--password,password] not found</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wchch.github.io/2019/06/15/搭建clickhouse监控/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alex Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/user_defined/logo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Alex‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/15/搭建clickhouse监控/" itemprop="url">搭建clickhouse监控</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-15T18:34:37+08:00">
                2019-06-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/olap/" itemprop="url" rel="index">
                    <span itemprop="name">olap</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/olap/BigData/" itemprop="url" rel="index">
                    <span itemprop="name">BigData</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/olap/BigData/clickhouse/" itemprop="url" rel="index">
                    <span itemprop="name">clickhouse</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/olap/BigData/clickhouse/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="原由与方案"><a href="#原由与方案" class="headerlink" title="原由与方案"></a>原由与方案</h3><p>为了更好地优化clickhouse的性能，需要对clickhouse集群进行监控。网上很多监控方案都是clickhouse + grafana + prometheus，因此打算使用此方案。</p>
<p>要想使用prometheus就得先安装exporter，clickhouse有第三方提供的<a href="https://github.com/f1yegor/clickhouse_exporter/blob/master/clickhouse_exporter.go" target="_blank" rel="noopener">clickhouse_exporter</a>，也有容器版本，并且提供了grafana的dashboard版本： <a href="https://grafana.net/dashboards/882。由于我们在集群中使用了代理CHproxy，但CHproxy也同时实现了exporter的功能，并且提供了更多的特性以及grafana" target="_blank" rel="noopener">https://grafana.net/dashboards/882。由于我们在集群中使用了代理CHproxy，但CHproxy也同时实现了exporter的功能，并且提供了更多的特性以及grafana</a> dashboard模板<a href="https://github.com/Vertamedia/chproxy/blob/master/chproxy_overview.json，所以我们也就直接使用。" target="_blank" rel="noopener">https://github.com/Vertamedia/chproxy/blob/master/chproxy_overview.json，所以我们也就直接使用。</a></p>
<h3 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h3><p>我们使用了docker进行部署，并且使用docker-compose进行编排，并且将配置文件和重要数据挂载到宿主机。</p>
<p>docker-compose如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">version: '3'</span><br><span class="line">services:</span><br><span class="line">  prometheus:</span><br><span class="line">    image: prom/prometheus:latest</span><br><span class="line">    restart: always</span><br><span class="line">    network_mode: host</span><br><span class="line">    user: root</span><br><span class="line">    container_name: prometheus</span><br><span class="line">    ports:</span><br><span class="line">      - "9090:9090"</span><br><span class="line">    depends_on:</span><br><span class="line">      - chproxy</span><br><span class="line">    volumes:</span><br><span class="line">      - ./prometheus.yml:/etc/prometheus/prometheus.yml</span><br><span class="line">      - ./prometheus-data:/prometheus</span><br><span class="line">  grafana:</span><br><span class="line">    image: grafana/grafana:latest</span><br><span class="line">    restart: always</span><br><span class="line">    network_mode: host</span><br><span class="line">    user: root</span><br><span class="line">    container_name: grafana</span><br><span class="line">    ports:</span><br><span class="line">      - "3000:3000"</span><br><span class="line">    depends_on:</span><br><span class="line">      - prometheus</span><br><span class="line">    volumes:</span><br><span class="line">      - ./grafana-data/var/lib/grafana:/var/lib/grafana</span><br><span class="line">      - ./grafana-data/etc/grafana:/etc/grafana</span><br><span class="line"></span><br><span class="line">  chproxy:</span><br><span class="line">    image: tacyuuhon/clickhouse-chproxy:1.13.2</span><br><span class="line">    restart: always</span><br><span class="line">    network_mode: host</span><br><span class="line">    container_name: chproxy</span><br><span class="line">    ports:</span><br><span class="line">      - 9092:9092</span><br><span class="line">    volumes:</span><br><span class="line">      - ./config.yml:/opt/config.yml</span><br></pre></td></tr></table></figure>
<p>CHproxy的配置文件<code>config.xml</code>，省略，参考上篇文章。</p>
<p>prometheus的配置文件<code>prometheus.xml</code>如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line"><span class="meta">  #</span> scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      # - alertmanager:9093</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</span><br><span class="line">rule_files:</span><br><span class="line"><span class="meta">  #</span> - "first_rules.yml"</span><br><span class="line"><span class="meta">  #</span> - "second_rules.yml"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"><span class="meta">#</span> Here it's Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line"><span class="meta">  #</span> The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span><br><span class="line">  - job_name: 'prometheus'</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to '/metrics'</span><br><span class="line">    # scheme defaults to 'http'.</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: ['localhost:9090']</span><br><span class="line"></span><br><span class="line">  - job_name: 'clickhouse-chproxy'</span><br><span class="line"></span><br><span class="line">    # 覆盖全局的 scrape_interval</span><br><span class="line">    scrape_interval: 10s</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: ['localhost:9092']</span><br></pre></td></tr></table></figure>
<p>可通过<code>http://ip:9090/targets</code>查看prometheus配置文件中配置的job是否成功。</p>
<p><strong>请注意：</strong></p>
<ol>
<li>因为docker-compose中使用的网络模式为<code>host</code>，所以在prometheus的配置文件中ip地址都写为<code>localhost</code>，并且要填上对应容器的端口。</li>
<li>grafana容器可将<code>/var/lib/grafana</code>和<code>/etc/grafana</code>目录拷贝出来放到宿主机上并且重新挂载到容器中这样的话删除并且重启容器时不会导致数据丢失。docker-compose中grafana和prometheus容器可能需要将<code>user</code>设为<code>root</code>，这样的话当宿主机的用户为<code>root</code>时就有权限写mount的目录。</li>
<li>当通过docker-compose编排好之后，通过’<a href="http://ip:3000&#39;登录grafana，并且配置好prometheus数据源，再将dashboard模板https://github.com/Vertamedia/chproxy/blob/master/chproxy_overview.json导入之后发现没有数据，连左上角的job下拉框都没有任何数据。然后我通过当前dashboard的`Variables`发现下拉框job的内容是通过prometheus中`go_info`来获取的，但是我通过promql查询`go_info`中没有`prometheus.yml`中配置的`-job_name`为`clickhouse-chproxy`的内容。但是我发现`go_goroutines`中有，于是我将`go_info`替换成了`go_goroutines`。" target="_blank" rel="noopener">http://ip:3000&#39;登录grafana，并且配置好prometheus数据源，再将dashboard模板https://github.com/Vertamedia/chproxy/blob/master/chproxy_overview.json导入之后发现没有数据，连左上角的job下拉框都没有任何数据。然后我通过当前dashboard的`Variables`发现下拉框job的内容是通过prometheus中`go_info`来获取的，但是我通过promql查询`go_info`中没有`prometheus.yml`中配置的`-job_name`为`clickhouse-chproxy`的内容。但是我发现`go_goroutines`中有，于是我将`go_info`替换成了`go_goroutines`。</a></li>
<li>经过测试返现只有CHproxy至少经过一次的使用查询之后<code>go_goroutines</code>中才有<code>-job_name</code>为<code>clickhouse-chproxy</code>的内容，其他metrics也是才会出现。</li>
</ol>
<p>go_goroutines</p>
<p>go_info没有别的信息，需要使用接口发送一次查询</p>
<p>grafana mount 需要 root user 当前host 为root</p>
<h3 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h3><p>我直接在grafana容器中安装了clickhouse DataSource插件，并且制作成了镜像，这样的话grafana也可以直接查询clickhouse了哦，参考：<a href="https://github.com/Vertamedia/clickhouse-grafana，https://grafana.com/plugins/vertamedia-clickhouse-datasource/installation。" target="_blank" rel="noopener">https://github.com/Vertamedia/clickhouse-grafana，https://grafana.com/plugins/vertamedia-clickhouse-datasource/installation。</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wchch.github.io/2019/06/14/解决clickhouse并发问题之CHproxy安装配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alex Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/user_defined/logo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Alex‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/14/解决clickhouse并发问题之CHproxy安装配置/" itemprop="url">解决clickhouse并发问题之CHproxy安装配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-14T21:33:52+08:00">
                2019-06-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/olap/" itemprop="url" rel="index">
                    <span itemprop="name">olap</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/olap/BigData/" itemprop="url" rel="index">
                    <span itemprop="name">BigData</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/olap/BigData/clickhouse/" itemprop="url" rel="index">
                    <span itemprop="name">clickhouse</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/olap/BigData/clickhouse/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>由于新的superset看板查询时每个chart涉及到的底表数据量增加以及并发较多导致clickhouse因为OOM挂掉而返回错误，并且影响到别的看板的使用以及整个系统的稳定性。但是单独查询某个chart是并没有问题，因此需要控制看板查询时的并发度。</p>
<h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>通过调研以及社区的帮助，可通过代理的方式控制并发度，并且可使用的代理有<code>[ProxySQL](https://proxysql.com/)</code>以及专门为clickhouse开发的第三方<a href="https://github.com/Vertamedia/chproxy" target="_blank" rel="noopener">CHproxy</a>。考虑到CHproxy对clickhouse的很多原生配置特性支持的比较好，比如<code>set</code>属性相关的（可以控制每个查询所使用的最大内存等）以及负载均衡，并发控制等等很多特性，故选择了CHproxy。</p>
<h3 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h3><p>CHproxy因为是go语言写的，因此安装部署也很简单，也可以通过docker进行部署，具体可以参考文档。启动命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./chproxy -config=/path/to/config.yml</span><br></pre></td></tr></table></figure>
<p>下面是配置文件，仅供参考：</p>
<p><code>config.yml</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  http:</span><br><span class="line">      listen_addr: ":9092"</span><br><span class="line"></span><br><span class="line">      # Networks with reporting servers.</span><br><span class="line">      allowed_networks: ["11.3.0.0/16","172.0.0.0/8","127.0.0.0/8"]</span><br><span class="line"></span><br><span class="line">users:</span><br><span class="line">  - name: "proxy-user"</span><br><span class="line">    password: "password"</span><br><span class="line">    to_cluster: "select"</span><br><span class="line">    to_user: "user"</span><br><span class="line">    max_concurrent_queries: 10</span><br><span class="line">    max_execution_time: 3m</span><br><span class="line">    max_queue_size: 120</span><br><span class="line">    max_queue_time: 120s</span><br><span class="line">    cache: "shortterm"</span><br><span class="line">    params: "cron-job"</span><br><span class="line"></span><br><span class="line">clusters:</span><br><span class="line">  - name: "select"</span><br><span class="line">    replicas:</span><br><span class="line">      - name: "replica1"</span><br><span class="line">        nodes: ["ip11:8123", "ip21:8123"]</span><br><span class="line">      - name: "replica2"</span><br><span class="line">        nodes: ["ip12:8123", "ip22:8123"]</span><br><span class="line">    heartbeat_interval: 1m</span><br><span class="line">    users:</span><br><span class="line">      - name: "user"</span><br><span class="line">        password: "password"</span><br><span class="line">        max_concurrent_queries: 10</span><br><span class="line">        max_execution_time: 3m</span><br><span class="line">        max_queue_size: 120</span><br><span class="line">        max_queue_time: 120s</span><br><span class="line"></span><br><span class="line">caches:</span><br><span class="line">  - name: "shortterm"</span><br><span class="line">    dir: "~/chproxy/cache/dir"</span><br><span class="line">    max_size: 150Mb</span><br><span class="line">    expire: 14400s</span><br><span class="line"></span><br><span class="line">param_groups:</span><br><span class="line">    # Group name, which may be passed into `params` option on the `user` level.</span><br><span class="line">  - name: "cron-job"</span><br><span class="line">    # List of key-value params to send</span><br><span class="line">    params:</span><br><span class="line">      - key: "max_memory_usage"</span><br><span class="line">        value: "9000000000"</span><br><span class="line"></span><br><span class="line">      - key: "max_bytes_before_external_group_by"</span><br><span class="line">        value: "4500000000"</span><br><span class="line"></span><br><span class="line">  - name: "web"</span><br><span class="line">    params:</span><br><span class="line">      - key: "max_memory_usage"</span><br><span class="line">        value: "5000000000"</span><br><span class="line"></span><br><span class="line">      - key: "max_columns_to_read"</span><br><span class="line">        value: "30"</span><br><span class="line"></span><br><span class="line">      - key: "max_execution_time"</span><br><span class="line">        value: "30"</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wchch.github.io/2019/05/13/更为灵活的编程式sql：superset中jinja-template的使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alex Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/user_defined/logo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Alex‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/13/更为灵活的编程式sql：superset中jinja-template的使用/" itemprop="url">更为灵活的编程式sql：superset中jinja template的使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-13T20:03:12+08:00">
                2019-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/使用/" itemprop="url" rel="index">
                    <span itemprop="name">使用</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/使用/可视化/" itemprop="url" rel="index">
                    <span itemprop="name">可视化</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>superset中仅仅是对数据表的操作很多时候还是没法满足我们的数据展示需求，因此superset提供了jinja template的方式让我们更为灵活地自定义sql语句。</p>
<h4 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h4><p>通过jinja中文文档<a href="http://docs.jinkan.org/docs/jinja2/templates.html，我们可以了解jinja" target="_blank" rel="noopener">http://docs.jinkan.org/docs/jinja2/templates.html，我们可以了解jinja</a> template如何使用，包括各种分隔符: </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% ... %&#125;</span><br><span class="line">&#123;&#123; ... &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>前者用于执行诸如 for 循环 或赋值的语句，后者把表达式的结果打印到模板上，filters，条件判断，宏等。</p>
<p>superset关于jinja template的说明：<a href="https://superset.incubator.apache.org/sqllab.html。其中superset提供了`filter_values`和`url_param`两个jinja方法，其中`filter_values`更为重要。`filter_values`可以接收filter_box这个chart的值，并且以列表的方式输出。" target="_blank" rel="noopener">https://superset.incubator.apache.org/sqllab.html。其中superset提供了`filter_values`和`url_param`两个jinja方法，其中`filter_values`更为重要。`filter_values`可以接收filter_box这个chart的值，并且以列表的方式输出。</a></p>
<p>superset还提供了一些操作函数，与python的import层级一一对应，比如：</p>
<ul>
<li><code>time</code>: <code>time</code></li>
<li><code>datetime</code>: <code>datetime.datetime</code></li>
<li><code>uuid</code>: <code>uuid</code></li>
<li><code>random</code>: <code>random</code></li>
<li><code>relativedelta</code>: <code>dateutil.relativedelta.relativedelta</code></li>
</ul>
<p>还可以使用jinja内置过滤器并且通过管道的方式使用：<a href="http://docs.jinkan.org/docs/jinja2/templates.html#id21。" target="_blank" rel="noopener">http://docs.jinkan.org/docs/jinja2/templates.html#id21。</a></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2019/05/13/更为灵活的编程式sql：superset中jinja-template的使用/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wchch.github.io/2019/04/12/spark-jdbc导数clickhouse时attempt的坑/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alex Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/user_defined/logo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Alex‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/12/spark-jdbc导数clickhouse时attempt的坑/" itemprop="url">spark jdbc导数clickhouse时attempt的坑</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-12T17:48:57+08:00">
                2019-04-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/问题/" itemprop="url" rel="index">
                    <span itemprop="name">问题</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/问题/spark/" itemprop="url" rel="index">
                    <span itemprop="name">spark</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/问题/spark/clickhouse/" itemprop="url" rel="index">
                    <span itemprop="name">clickhouse</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/问题/spark/clickhouse/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>spark 的容错机制会使得spark application失败时尝试重启，从web ui中我们就可以看到其<code>Attempt ID</code>大于1。这是个好的机制，但是对于通过jdbc将数据导入clichouse的过程来说却是个不好的体验。因为如果重启的application的话会导致导入的数据重复，使得总的数据量增多，然后zookeeper有数据块的校验机制。</p>
<p>可通过<code>--conf spark.yarn.maxAppAttempts=1</code>使得application的重启次数为1，但是又带来可能出现的数据导入不全的情况出现。</p>
<p>看来得寻找一种好的数据导入工具，希望是操作友好，可视化，有监控，易管理，数据不会重复导入的工具。网上看了一下好像NIFI还不错，先调研调研。</p>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>加快导数clickhouse的速度，缩短导入时间，这样就能够大概率上避免spark attempt的出现。具体方法是：</p>
<p>在spark的jdbc properties中</p>
<ol>
<li>设置合适的batchsize。</li>
<li>设置合适的并发度。</li>
<li>设置合适的内存使用量。</li>
</ol>
<p>可参考上篇文章：<a href="https://wchch.github.io/2019/04/12/%E8%A7%A3%E5%86%B3clickhouse%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E6%97%B6%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA%E5%AF%BC%E8%87%B4docker%E6%8C%82%E6%8E%89%E7%9A%84%E9%97%AE%E9%A2%98/#more">解决clickhouse批量插入时内存溢出导致docker挂掉的问题</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wchch.github.io/2019/04/12/解决clickhouse批量插入时内存溢出导致docker挂掉的问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alex Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/user_defined/logo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Alex‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/12/解决clickhouse批量插入时内存溢出导致docker挂掉的问题/" itemprop="url">解决clickhouse批量插入时内存溢出导致docker挂掉的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-12T11:20:53+08:00">
                2019-04-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/olap/" itemprop="url" rel="index">
                    <span itemprop="name">olap</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/olap/BigData/" itemprop="url" rel="index">
                    <span itemprop="name">BigData</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/olap/BigData/clickhouse/" itemprop="url" rel="index">
                    <span itemprop="name">clickhouse</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/olap/BigData/clickhouse/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>为了加快导入数据的速度我将针对每个分片的导入并行度都设置为3，如下配置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">properties_4_click_order_behavior = &#123;<span class="string">'driver'</span>: <span class="string">'ru.yandex.clickhouse.ClickHouseDriver'</span>,</span><br><span class="line">              <span class="string">"socket_timeout"</span>: <span class="string">"300000"</span>,</span><br><span class="line">              <span class="string">"rewriteBatchedStatements"</span>: <span class="string">"true"</span>,</span><br><span class="line">              <span class="string">"batchsize"</span>: <span class="string">"1000000"</span>,</span><br><span class="line">              <span class="string">"numPartitions"</span>: <span class="string">"3"</span>,</span><br><span class="line">              <span class="string">'user'</span>: CONF_CONSTANT.user,</span><br><span class="line">              <span class="string">'password'</span>: CONF_CONSTANT.password&#125;</span><br></pre></td></tr></table></figure>
<p>之后各个分片就报出了<code>connection refused</code>的问题，然后运维那边说是内存溢出了，我们的每个分片的内存只有24G。当然，当<code>numPartitions</code>为1的时候是没问题的。</p>
<p>我还是是希望能够加快能够加快导入速度，1个并行插入效率确实低，而且还有一个让我比较疑惑的地方是，我们有一个只有3个容器，配置为8核，32G，只有1副本，但是我令<code>numPartitions</code>为12，<code>batchsize</code>为20000000都没有问题。</p>
<h3 id="初步解决"><a href="#初步解决" class="headerlink" title="初步解决"></a>初步解决</h3><p>这里得感谢，QQ群<code>Clickhouse牛人帮</code>的几位大牛的帮助，我通过翻聊天记录查看到与我遇到类似问题的，并且有了解决方法，就是通过设置<code>max_memory_usage</code>和<code>max_bytes_before_external_group_by</code>来控制内存使用，按照官方文档建议，<code>max_bytes_before_external_group_by</code>为<code>max_memory_usage</code>二分之一。既然容器的内存只有24G，那我就设置<code>max_memory_usage</code>为20G好了，设置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">properties_4_click_order_behavior = &#123;&apos;driver&apos;: &apos;ru.yandex.clickhouse.ClickHouseDriver&apos;,</span><br><span class="line">              &quot;socket_timeout&quot;: &quot;300000&quot;,</span><br><span class="line">              &quot;rewriteBatchedStatements&quot;: &quot;true&quot;,</span><br><span class="line">              &quot;batchsize&quot;: &quot;1000000&quot;,</span><br><span class="line">              &quot;numPartitions&quot;: &quot;3&quot;,</span><br><span class="line">              &apos;user&apos;: &quot;user&quot;,</span><br><span class="line">              &apos;password&apos;: &quot;password&quot;,</span><br><span class="line">              &apos;max_memory_usage&apos;: &quot;20000000000&quot;,</span><br><span class="line">              &apos;max_bytes_before_external_group_by&apos;: &quot;10000000000&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>一开始我设置<code>numPartitions</code>为8，但是仍然出现<code>connection refused</code>的问题，后来调整成3就好了。为什么这样呢？</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2019/04/12/解决clickhouse批量插入时内存溢出导致docker挂掉的问题/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wchch.github.io/2019/04/09/解决OutOfMemoryError-Direct-buffer-memory问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alex Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/user_defined/logo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Alex‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/09/解决OutOfMemoryError-Direct-buffer-memory问题/" itemprop="url">解决OutOfMemoryError: Direct buffer memory问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-09T16:32:02+08:00">
                2019-04-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/BigData/" itemprop="url" rel="index">
                    <span itemprop="name">BigData</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/BigData/Spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/BigData/Spark/Spark-Sql，调优/" itemprop="url" rel="index">
                    <span itemprop="name">Spark-Sql，调优</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>近日处理一些大数据时老是出现<code>OutOfMemoryError: Direct buffer memory</code>的问题，一开始以为是数据倾斜问题，然后使用拆分倾斜key分别join再union的方法处理数据倾斜。后来测试发现，反而是非倾斜部分的数据进行join时出现了此问题。</p>
<h4 id="实验过程"><a href="#实验过程" class="headerlink" title="实验过程"></a>实验过程</h4><p>我做了些实验：</p>
<ol>
<li>大表<code>column1</code>中<code>-</code>和<code>notset</code>字符串的量分别为8.5亿和2.8亿，占了大约总量的二分之一。</li>
<li>这两张表中个表我只取<code>column1</code>这个字段，并且根据<code>column1</code> groupby 之后cont()为num，再将这两张表的结果进行join，并且增加列为表1的num乘以<br>表2的num的结果，即为两张原始表join后的数量。结果发现前三数量最大的为16780380，255084，147246，无<code>-</code>或是字符串<code>notset</code>。</li>
<li>小表table1中没有<code>column1</code>为 <code>-</code>或是字符串<code>notset</code>， 同样这两个字符串也不会再步骤2中出现。也就是<code>-</code>和字符串<code>notset</code>在left join中起不到任何作用，只会在shuffle是占用大量空间。</li>
<li>通过观察web ui 中的sql 标签页，发现都是大表与大表的“SortMergeJoin”。</li>
<li>因为左连接左小表table1的<code>column1</code>中没有<code>-</code>和字符串<code>notset</code>，在读取右大表直接过滤掉<code>column1</code>中含<code>-</code>和字符串<code>notset</code>的列，至此实验通过，不再报<code>OutOfMemoryError: Direct buffer memory</code>的问题。</li>
</ol>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2019/04/09/解决OutOfMemoryError-Direct-buffer-memory问题/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wchch.github.io/2019/04/04/sparkSql操作hive表的PlainValuesDictionary问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alex Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/user_defined/logo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Alex‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/04/sparkSql操作hive表的PlainValuesDictionary问题/" itemprop="url">sparkSql操作hive表的PlainValuesDictionary问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-04T09:25:50+08:00">
                2019-04-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/BigData/" itemprop="url" rel="index">
                    <span itemprop="name">BigData</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/BigData/Spark/" itemprop="url" rel="index">
                    <span itemprop="name">Spark</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/BigData/Spark/Spark-Sql，问题/" itemprop="url" rel="index">
                    <span itemprop="name">Spark-Sql，问题</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>操作hive表时出现一下报错：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.parquet.column.values.dictionary.PlainValuesDictionary$PlainIntegerDictionary</span><br></pre></td></tr></table></figure>
<p>原因：parquet文件中某些列的数据类型不一致。</p>
<p>例如这个表的某一列的schema类型为string，但是这一列的数据是从不同的数据源插入的，但是某些数据源的类型是int，却也能插入成功，所以当操作此表并且包含此列时，就可能会出现以上问题。</p>
<p>解决：</p>
<p>不同类型的数据插入表时，强制转化成与表schema一致的类型。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/user_defined/logo.jpg"
                alt="Alex Wong" />
            
              <p class="site-author-name" itemprop="name">Alex Wong</p>
              <p class="site-description motion-element" itemprop="description">不管年龄大小，每个人都是我的老师</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">46</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">57</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">55</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://shalk.xyz/" title="shalk" target="_blank">shalk</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://luckylau.tech/" title="luckylau" target="_blank">luckylau</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alex Wong</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
